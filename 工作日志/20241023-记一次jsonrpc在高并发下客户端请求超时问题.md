# 20241023

记一次jsonrpc在高并发下，客户端请求超时问题。

## 背景

劳务OpenApi迁移到统一开放平台后，使用Hutool工具包中的HttpClient发起jsonrpc请求出现大量**Read Time Out**异常，网关响应码为499，网关查看耗时为0（读取数据未完成客户端就断开连接主动）。劳务OpenApi的流量巨大（CPM 10万+）。

1. 排查过程

- 查看监控发现资源充足不存在资源耗尽问题。
- 检查代码逻辑正确。
- 怀疑Http客户端工具存在性能问题或未知缺陷，使用的Hutool的Http工具。查看其源码设计很简单，底层调用的是JDK的HttpURLConnection，每次请求都会创建一个连接并没有连接池化设计。
- 使用支持连接池化的OkHttp3替换Hutool发起jsonrpc请求，问题解决。

2. 总结

在高并发场景下不使用连接池化技术会导致每次请求都创建一个TCP连接，可能导致客户端读取超时出现**Read Time Out**异常，所以在高并发场景下推荐使用支持连接池化的Http客户端，复用TCP连接提升性能。